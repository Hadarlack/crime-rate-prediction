#תרשימי פיזור משתנים מסבירים
#install.packages("moments("
library(moments)
dataset<-read.csv(file.choose(),header = T)
plot(dataset)
plot(x=dataset$Life.expectancy,y=dataset$Number.of.murders,xlab="Life expectancy ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Life.expectancy), col="hotpink")
plot(x=dataset$Gini.Index,y=dataset$Number.of.murders,xlab="Gini index ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Gini.Index), col="hotpink")
plot(x=dataset$GDP,y=dataset$Number.of.murders,xlab="GDP ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$GDP), col="hotpink")
plot(x=dataset$Alcohol.Consumption,y=dataset$Number.of.murders,xlab="Alcohol consumption ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Alcohol.Consumption), col="hotpink")
plot(x=dataset$Population.density..per.square.km.,y=dataset$Number.of.murders,xlab="Population density ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Population.density..per.square.km.), col="hotpink")
plot(x=dataset$Poverty.rate,y=dataset$Number.of.murders,xlab="Poverty rate ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Poverty.rate), col="hotpink")
plot(x=dataset$Smokers,y=dataset$Number.of.murders,xlab="Smokers ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Smokers), col="hotpink")
plot(x=dataset$Death.penalty.permitted,y=dataset$Number.of.murders,xlab="Death penalty permitted",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Death.penalty.permitted), col="hotpink")
plot(x=dataset$Divorce.rate,y=dataset$Number.of.murders,xlab="Divorce rate ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Divorce.rate), col="hotpink")
plot(x=dataset$Temperature,y=dataset$Number.of.murders,xlab="Temperature ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Temperature), col="hotpink")
plot(x=dataset$Precentage.of.green.areas,y=dataset$Number.of.murders,xlab="Precentage of green areas ",ylab="Number of murders")
abline(lm(dataset$Number.of.murders~dataset$Precentage.of.green.areas), col="hotpink")
boxplot(dataset$Number.of.murders~dataset$Major.religion)
cor(dataset[sapply(dataset, function(x) !is.factor(x))],method = "pearson")

#משתני אינטרקציה
mod<-lm(formula=dataset$Number.of.murders~dataset$Gini.Index*factor(dataset$Death.penalty.permitted))
summary(mod)
plot(dataset$Gini.Index[dataset$Death.penalty.permitted=='0'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='0'], col="brown",xlim = c(15,60),ylim=c(0,60) ,xlab="Gini index",ylab="murders", main = "murders vs. Gini index")
points(dataset$Gini.Index[dataset$Death.penalty.permitted=='1'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='1'], col="blue")
abline(a=-12.98329,b=0.51263, col="brown")
abline(a=-12.98329-0.25138, b=0.51263+0.05343, col='blue')
mod<-lm(formula=dataset$Number.of.murders~dataset$Life.expectancy*factor(dataset$Death.penalty.permitted))
summary(mod)
plot(dataset$Life.expectancy[dataset$Death.penalty.permitted=='0'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='0'], col="brown",xlim = c(60,100),ylim=c(0,60) ,xlab="life expectancy",ylab="murders", main = "murders vs. life expectancy")
points(dataset$Life.expectancy[dataset$Death.penalty.permitted=='1'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='1'], col="blue")
abline(a=73.3275,b=-0.8746, col="brown")
abline(a=73.3275+66.1327, b=-0.8746-0.8297, col='blue')
mod<-lm(formula=dataset$Number.of.murders~dataset$GDP*factor(dataset$Death.penalty.permitted))
summary(mod)
plot(dataset$GDP[dataset$Death.penalty.permitted=='0'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='0'], col="brown",xlim = c(400,55000),ylim=c(0,60) ,xlab="GDP",ylab="murders",main = "murders vs. GDP")
points(dataset$GDP[dataset$Death.penalty.permitted=='1'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='1'], col="blue")
abline(a=8.462e+00,b=-2.306e-04, col="brown")
abline(a=8.462e+00+4.474e+00, b=-2.306e-04+7.782e-06, col='blue')
mod<-lm(formula=dataset$Number.of.murders~dataset$Poverty.rate*factor(dataset$Death.penalty.permitted))
summary(mod)
plot(dataset$Poverty.rate[dataset$Death.penalty.permitted=='0'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='0'], col="brown",xlim = c(0,90),ylim=c(0,60) ,xlab="poverty rate",ylab="murders", main = "murders vs. poverty rate")
points(dataset$Poverty.rate[dataset$Death.penalty.permitted=='1'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='1'], col="blue")
abline(a= -1.8186,b=0.3550, col="brown")
abline(a=-1.8186+10.0502, b=0.3550-0.2643, col='blue')
mod<-lm(formula=dataset$Number.of.murders~dataset$Divorce.rate*factor(dataset$Death.penalty.permitted))
summary(mod)> plot(dataset$Divorce.rate[dataset$Death.penalty.permitted=='0'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='0'], col="brown",xlim = c(0,80),ylim=c(0,60) ,xlab="divorce rate",ylab="murders", main = "murders vs. divorce rate")
points(dataset$Divorce.rate[dataset$Death.penalty.permitted=='1'] ,dataset$Number.of.murders[dataset$Death.penalty.permitted=='1'], col="blue")
abline(a=9.21654,b= -0.12119, col="brown")
abline(a= 9.21654+2.90973, b=-0.12119+0.03268, col='blue')
                   
#דתות) 3 דתות(
dataset$religion.fac <- factor(dataset$religion.cat)
summary(mod)
mod<-lm(formula=dataset$Number.of.murders ~ dataset$Gini.Index*dataset$religion.fac)
plot(dataset$Gini.Index[dataset$religion.cat=='1'],dataset$Number.of.murders[dataset$religion.cat=='1'], col="red",xlim = c(15,60), ylim=c(0,60) ,xlab="Gini",ylab="Murders", main = "Gini VS. Murders")
points(dataset$Gini.Index[dataset$religion.cat=='2'],dataset$Number.of.murders[dataset$religion.cat=='2'], col="Green" )
points(dataset$Gini.Index[dataset$religion.cat=='3'],dataset$Number.of.murders[dataset$religion.cat=='3'], col="purple" )
abline(a= 6.04301, b=-0.10753, col="red")
abline(a= 6.04301 + -2.80132, b=-0.10753 + 0.09062, col="Green")
abline(a= 6.04301 -23.89823, b=-0.10753 + 0.82526, col="purple")
mod<-lm(formula=dataset$Number.of.murders ~ dataset$Life.expectancy*dataset$religion.fac)
summary(mod)
plot(dataset$Life.expectancy[dataset$religion.cat=='1'],dataset$Number.of.murders[dataset$religion.cat=='1'],col="red",xlim = c(60,100), ylim=c(0,60) ,xlab="Life expectancy",ylab="Murders",main = "Life expectancy VS. Murders")
points(dataset$Life.expectancy[dataset$religion.cat=='2'],dataset$Number.of.murders[dataset$religion.cat=='2'], col="Green" )
points(dataset$Life.expectancy[dataset$religion.cat=='3'],dataset$Number.of.murders[dataset$religion.cat=='3'], col="purple" )
abline(a= -12.9818, b=0.1818, col="red")
abline(a= -12.9818+23.6053, b=0.1818-0.2865, col="green")
abline(a= -12.9818+145.1816, b=0.1818-1.7854, col="purple")
mod<-lm(formula=dataset$Number.of.murders ~ dataset$Poverty.rate*dataset$religion.fac)
summary(mod)
plot(dataset$Poverty.rate[dataset$religion.cat=='1'],dataset$Number.of.murders[dataset$religion.cat=='1'], col="red",xlim = c(0,100), ylim=c(0,60) ,xlab="poverty rate",ylab="Murders", main = "poverty rate VS. Murders")
points(dataset$Poverty.rate[dataset$religion.cat=='2'],dataset$Number.of.murders[dataset$religion.cat=='2'], col="Green" )
points(dataset$Poverty.rate[dataset$religion.cat=='3'],dataset$Number.of.murders[dataset$religion.cat=='3'], col="purple" )
abline(a= 0.61635, b=0.06289, col="red")
abline(a= 0.61635+1.04135, b=0.06289-0.01985, col="green")
abline(a= 0.61635-2.74946, b=0.06289+0.45790, col="purple")
mod<-lm(formula=dataset$Number.of.murders ~ dataset$Divorce.rate*dataset$religion.fac)
summary(mod)
plot(dataset$Divorce.rate[dataset$religion.cat=='1'],dataset$Number.of.murders[dataset$religion.cat=='1'], col="red",xlim = c(0,100), ylim=c(0,60) ,xlab="divorce rate",ylab="Murders", main = "dvorce rate VS. Murders")
points(dataset$Divorce.rate[dataset$religion.cat=='2'],dataset$Number.of.murders[dataset$religion.cat=='2'], col="Green" )
points(dataset$Divorce.rate[dataset$religion.cat=='3'],dataset$Number.of.murders[dataset$religion.cat=='3'], col="purple" )
abline(a= 16.0000, b=-0.5000, col="red")
abline(a= 16.0000-14.6331, b=-0.5000+0.5629, col="green")
abline(a= 16.0000+0.7379, b=-0.5000+0.2456 , col="purple")
mod<-lm(formula=dataset$Number.of.murders ~ dataset$GDP*dataset$religion.fac)
summary(mod)
plot(dataset$GDP[dataset$religion.cat=='1'],dataset$Number.of.murders[dataset$religion.cat=='1'], col="red",xlim = c(750,55000), ylim=c(0,60) ,xlab="GDP",ylab="Murders", main = "GDP VS. Murders")
points(dataset$GDP[dataset$religion.cat=='2'],dataset$Number.of.murders[dataset$religion.cat=='2'], col="Green" )
points(dataset$GDP[dataset$religion.cat=='3'],dataset$Number.of.murders[dataset$religion.cat=='3'], col="purple" )
abline(a= 8.695e-01, b= 4.946e-05, col="red")
abline(a= 8.695e-01+ 2.054e+00, b= 4.946e-05-7.485e-05 , col="green")
abline(a= 8.695e-01+ 1.156e+01, b= 4.946e-05-3.640e-04, col="purple")
dataset<-read.csv(file.choose(),header = T)
mod<-lm(formula=dataset$Number.of.murders~dataset$Gini.Index*factor(dataset$religion.new))
summary(mod)
plot(dataset$Divorce.rate[dataset$religion.new=='1'],dataset$Number.of.murders[dataset$religion.new=='1'], col="red",xlim = c(0,100), ylim=c(0,60) ,xlab="divorce rate",ylab="Murders", main = "divorce rate VS. Murders")
points(dataset$Divorce.rate[dataset$religion.new=='2'],dataset$Number.of.murders[dataset$religion.new=='2'], col="Green" )
points(dataset$Divorce.rate[dataset$religion.new=='3'],dataset$Number.of.murders[dataset$religion.new=='3'], col="purple" )
abline(a= 2.000e+00, 1.075e-13, col="red")
abline(a= 2.000e+00-1.181e+00, 1.075e-13+ 3.794e-02, col="green")
dataset<-read.csv(file.choose(),header = T)
mod<-lm(formula=dataset$Number.of.murders~dataset$Gini.Index*factor(dataset$religion.new))
summary(mod)
dataset$religion.fac<-factor(dataset$religion.new)
plot(dataset$Gini.Index[dataset$religion.fac=='0'] ,dataset$Number.of.murders[dataset$religion.fac=='0'], col="purple",xlim = c(15,60),ylim=c(0,60) ,xlab="Gini index",ylab="murders", main = "murders vs. Gini index")
points(dataset$Gini.Index[dataset$religion.fac=='1'] ,dataset$Number.of.murders[dataset$religion.fac=='1'], col="green")
abline(a=-17.8552,b=0.7177, col="purple")
abline(a=-17.8552+21.4633, b=0.7177-0.7458, col='green')
plot(dataset$Life.expectancy[dataset$religion.fac=='0'],dataset$Number.of.murders[dataset$religion.fac=='0'], col="purple",xlim = c(60,90),ylim=c(0,60),xlab="Life Expactancy",ylab="murders", main = "murders vs. Life Expactancy")
points(dataset$Life.expectancy[dataset$religion.fac=='1'] ,dataset$Number.of.murders[dataset$religion.fac=='1'], col="green")
abline(a=132.1998,b=-1.6036, col="purple")
abline(a=132.1998-121.6926, b=-1.6036+1.4997, col='green')
GDP
plot(dataset$GDP[dataset$religion.fac=='0'],dataset$Number.of.murders[dataset$religion.fac=='0'],col="purple",xlim = c(500,55000),ylim=c(0,60),xlab="GDP",ylab="murders", main = "murders vs. GDP")
points(dataset$GDP[dataset$religion.fac=='1'] ,dataset$Number.of.murders[dataset$religion.fac=='1'], col="green")
abline(a=1.243e+01,b= -3.145e-04, col="purple")
abline(a= 1.243e+01-9.630e+00, b=-3.145e-04+2.927e-04, col='green')
                     
#עוני
plot(dataset$Poverty.rate[dataset$religion.fac=='0'],dataset$Number.of.murders[dataset$religion.fac=='0'], col="purple",xlim = c(0,90),ylim=c(0,60),xlab="Poverty Rate",ylab="murders", main = "Murders vs. Poverty Rate")
points(dataset$Poverty.rate[dataset$religion.fac=='1'] ,dataset$Number.of.murders[dataset$religion.fac=='1'], col="green")
abline(a=-2.1331,b= 0.5208, col="purple")
abline(a= -2.1331+ 3.7031, b=0.5208-0.4761, col='green')

#גירושין
plot(dataset$Divorce.rate[dataset$religion.fac=='0'],dataset$Number.of.murders[dataset$religion.fac=='0'], col="purple",xlim = c(0,70),ylim=c(0,70),xlab="Divorce Rate",ylab="murders", main = "Murders vs. Divorce Rate")
points(dataset$Divorce.rate[dataset$religion.fac=='1'] ,dataset$Number.of.murders[dataset$religion.fac=='1'], col="green")
abline(a=16.73791,b= -0.25466, col="purple")
abline(a=16.73791-15.26996,b= -0.25466+0.30644, col="green")

#הכרזת קטגוריאליים ומודל מלא עם האינטרקציות
#install.packages("moments")
  library(moments)
 dataset<-read.csv(file.choose(),header = T)
 Death.penalty.permitted.category<-as.factor(dataset$Death.penalty.permitted)
 religion.category<-as.factor(dataset$religion.new)
 lm.full <- lm(Number.of.murders~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data=dataset)

 #:Forward elimination שיטת
  #AIC
lm.null <- lm(dataset$Number.of.murders ~ 1, data = dataset)
model.aic.forward <- step(lm.null, direction = "forward", trace = 1, scope = ~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate)
summary(model.aic.forward)
                    
 # חלקי F
lm.full <- lm(Number.of.murders~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data = dataset)
lm.null <- lm(Number.of.murders ~ 1, data = dataset)
add1(lm.null, scope = ~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data = dataset, test = "F")
add1(update(lm.null, ~ . +Gini.Index), scope =~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data = dataset, test = "F")
add1(update(lm.null, ~ . +Gini.Index+religion.category), scope =~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data =dataset, test = "F")
add1(update(lm.null, ~ . +Gini.Index+religion.category+Life.expectancy), scope =~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data = dataset, test = "F")
add1(update(lm.null, ~ . +Gini.Index+religion.category+Life.expectancy+Death.penalty.permitted.category), scope =~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data = dataset, test = "F")
                     
#:Backward elimination שיטת
# AIC
 model.aic.backward <- step(lm.full, direction = "backward", trace = 1)
 summary(model.aic.backward)
            
# חלקי: F
lm.full <- lm(Number.of.murders~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate, data = dataset)
lm.null <- lm(Number.of.murders ~ 1, data = dataset)
 drop1(lm.full, test = "F")
 drop1(update(lm.full, ~ . -GDP), test = "F")
drop1(update(lm.full, ~ . -GDP-Poverty.rate:Death.penalty.permitted.category), test = "F")
drop1(update(lm.full, ~ . -GDP-Poverty.rate:Death.penalty.permitted.category-Divorce.rate), test= "F")
drop1(update(lm.full, ~ . -GDP-Poverty.rate:Death.penalty.permitted.category-Divorce.rate-Poverty.rate:religion.category), test = "F")

#stepwise regression שיטת
model.aic.both <- step(lm.null, direction = "both", trace = 1, scope = ~Life.expectancy+Gini.Index+GDP+Poverty.rate+religion.category+Divorce.rate+Death.penalty.permitted.category+religion.category:Life.expectancy+religion.category:Poverty.rate+Death.penalty.permitted.category:Poverty.rate)
summary(model.aic.both)
                  
#   בדיקת הנחות המודל:
#  מודל סופי
lm(formula = dataset$Number.of.murders ~ Gini.Index + religion.new +Life.expectancy + Death.penalty.permitted + Poverty.rate +religion.new:Life.expectancy, data = dataset)
                     
#הנחת שוויון שונויות
#תרשים פיזור של השגיאות המתוקננות מול הערך הצפוי:
data.lm = lm(Number.of.murders ~ Life.expectancy + Gini.Index + Poverty.rate + religion.new + Death.penalty.permitted + Life.expectancy:religion.new+ , data=dataset)
data.res = resid(data.lm)
plot(dataset$Number.of.murders, data.res,ylab ="Residuals",xlab="Number Of Murders")
abline(0,0)
            
#הנחת הנורמליות של השגיאות:
dataset$fitted<-fitted(data.lm)
dataset$residuals<-residuals(data.lm)
s.e_res<-sqrt(var(dataset$residuals))
dataset$stan_residuals<-(residuals(data.lm)/s.e_res)
qqnorm(dataset$stan_residuals)
abline(a=0,b=1)
hist(dataset$stan_residuals,xlab="Normalized error", main= "Histogram of normalized error")

#:SW- ו KS מבחן
ks.test(x=dataset$stan_residuals, y="pnorm", alternative = "two.sided", exact=NULL)
shapiro.test(dataset$stan_residuals)

#שיפור המודל:
#BOXCOX גרף

library(MASS)
modelBC<- boxcox(I(dataset$Number.of.murders+ 0.0005)~Life.expectancy + Gini.Index + Poverty.rate+ religion.new + Death.penalty.permitted + Life.expectancy:religion.new, data=dataset,lambda = seq(0, 0.5, 1/20))
cbind(modelBC$x,modelBC$y)[order(modelBC$y),]
                     
#: בחזקת 0.29 Y כתיבת מודל חדש עם העלאת
NewMod2<-lm(dataset$Number.of.murders^(0.29)~dataset$Life.expectancy + dataset$Gini.Index + dataset$Poverty.rate + dataset$religion.new + dataset$Death.penalty.permitted + dataset$Life.expectancy:dataset$religion.new)
NewMod2F<-fitted(NewMod2)
 res=resid(NewMod2)
s.e_res<-sqrt(var(res))
 stan_res<-(residuals(NewMod2)/s.e_res)
plot(NewMod2F, stan_res, ylab="Normalized error", xlab="Predicted value")
 abline(0,0)
 qqnorm(stan_res)
abline(0,1)
hist(stan_res, xlab= "Normalized error", main="Histogram of normalized error")